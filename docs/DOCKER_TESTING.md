# Docker + Database çµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒ

Next.js Todoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§Docker ã‚’ä½¿ç”¨ã—ã¦Firebase Emulatorã‚’å«ã‚€çµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’æ§‹ç¯‰ã—ã€APIçµ±åˆãƒ†ã‚¹ãƒˆã¨E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹ãŸã‚ã®ç’°å¢ƒæ§‹ç¯‰ã¨ä½¿ç”¨æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ—ï¸ æ§‹ç¯‰ã•ã‚ŒãŸç’°å¢ƒ

### Dockeræ§‹æˆ
- **Next.js App (TodoApp)**: ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒãƒ¼ãƒˆ3000/3001ï¼‰
- **Firebase Emulator Suite**: Node.js Alpine ãƒ™ãƒ¼ã‚¹ã§Firestore + Auth ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼
- **ãƒ†ã‚¹ãƒˆå°‚ç”¨ç’°å¢ƒ**: é–‹ç™ºç’°å¢ƒã¨åˆ†é›¢ã•ã‚ŒãŸçµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒ
- **E2Eãƒ†ã‚¹ãƒˆç’°å¢ƒ**: Playwright ã«ã‚ˆã‚‹è‡ªå‹•ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆ
- **çµ±åˆãƒ†ã‚¹ãƒˆå°‚ç”¨ã‚³ãƒ³ãƒ†ãƒŠ**: Vitest + Firebase Emulatoré€£æº

### ãƒ†ã‚¹ãƒˆç¨®åˆ¥ã¨ã‚«ãƒãƒ¬ãƒƒã‚¸
- **çµ±åˆãƒ†ã‚¹ãƒˆ (Integration Test)**: API â†” Firebase Emulatoré–“ã®å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ç¢ºèª
  - **Todo API**: GET/POST/PUT/DELETE å…¨æ“ä½œ
  - **Lists API**: ãƒªã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½
  - **èªè¨¼ãƒ•ãƒ­ãƒ¼**: NextAuth.js + Firebase Admin SDK
  - **å‹å®‰å…¨æ€§**: TypeScript strict modeæº–æ‹ 
- **E2Eãƒ†ã‚¹ãƒˆ (End-to-End Test)**: ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œ â†” DBåæ˜ ç¢ºèª
  - **Todoæ©Ÿèƒ½å…¨ãƒ•ãƒ­ãƒ¼**: ä½œæˆâ†’ç·¨é›†â†’å‰Šé™¤â†’ãƒ”ãƒ³ç•™ã‚
  - **ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—**: @dnd-kit ã«ã‚ˆã‚‹ä¸¦ã³æ›¿ãˆ
  - **ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ**: ãƒ¢ãƒã‚¤ãƒ«/ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è¡¨ç¤º

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# Firebase CLIï¼ˆæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆï¼‰
npm install -g firebase-tools

# Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npx playwright install
```

### 2. é–‹ç™ºç’°å¢ƒã®èµ·å‹•

```bash
# é–‹ç™ºç”¨Dockerç’°å¢ƒã®èµ·å‹•ï¼ˆNextJS + Firebase Emulatorï¼‰
npm run docker:dev

# ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿UIã‚¢ã‚¯ã‚»ã‚¹
# http://localhost:4000 - Firebase Emulator UI
# http://localhost:3000 - NextJSã‚¢ãƒ—ãƒª
```

### 3. ãƒ†ã‚¹ãƒˆå°‚ç”¨ç’°å¢ƒã®èµ·å‹•

```bash
# ãƒ†ã‚¹ãƒˆå°‚ç”¨Dockerç’°å¢ƒã®èµ·å‹•
npm run docker:test

# ãƒ†ã‚¹ãƒˆç’°å¢ƒã¸ã®ã‚¢ã‚¯ã‚»ã‚¹
# http://localhost:4001 - Firebase Emulator UI (ãƒ†ã‚¹ãƒˆç”¨)
# http://localhost:3001 - NextJSã‚¢ãƒ—ãƒª (ãƒ†ã‚¹ãƒˆç”¨)
```

**æ³¨æ„**: Firebase Emulatorã¯åˆå›èµ·å‹•æ™‚ã«Javaãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¨Firebase CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

### 4. çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆAPI Integration Testï¼‰ã®å®Ÿè¡Œ

```bash
# çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œï¼ˆTodo API + Lists APIï¼‰
npm run test:integration

# çµ±åˆãƒ†ã‚¹ãƒˆã®ç›£è¦–ãƒ¢ãƒ¼ãƒ‰ï¼ˆUIä»˜ãï¼‰
npm run test:integration:ui

# Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
npm run docker:test:run

# çµ±åˆãƒ†ã‚¹ãƒˆçµæœä¾‹
# âœ… Todo APIçµ±åˆãƒ†ã‚¹ãƒˆ (4ãƒ†ã‚¹ãƒˆ)
#   - GET /api/(general)/todos: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Todoå–å¾—
#   - POST /api/(general)/todos: æ–°è¦Todoä½œæˆï¼ˆ201 Createdï¼‰
#   - PUT /api/(general)/todos: æ—¢å­˜Todoæ›´æ–°
#   - DELETE /api/(general)/todos: Todoå‰Šé™¤
# âœ… Lists APIçµ±åˆãƒ†ã‚¹ãƒˆ (1ãƒ†ã‚¹ãƒˆ)
#   - GET /api/(general)/lists: ãƒªã‚¹ãƒˆä¸€è¦§å–å¾—
```

### 5. E2Eãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
# E2Eãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
npm run test:e2e

# E2Eãƒ†ã‚¹ãƒˆã®UIãƒ¢ãƒ¼ãƒ‰
npm run test:e2e:ui

# Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
npm run docker:e2e:run
```

### 6. ç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```bash
# ãƒ†ã‚¹ãƒˆç’°å¢ƒã®åœæ­¢
npm run docker:test:down

# é–‹ç™ºç’°å¢ƒã®åœæ­¢
docker-compose down
```

**ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®è©³ç´°ã¯[PRODUCTS.md - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ](PRODUCTS.md#ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ )ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚**

## ğŸ”§ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### ãƒãƒ¼ãƒˆè¨­å®šã®å¤‰æ›´

å¿…è¦ã«å¿œã˜ã¦ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒãƒ¼ãƒˆã‚’å¤‰æ›´ã§ãã¾ã™ï¼š

- `docker-compose.yml`: é–‹ç™ºç’°å¢ƒã®ãƒãƒ¼ãƒˆ
- `docker-compose.test.yml`: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ãƒãƒ¼ãƒˆ
- `firebase.json` / `firebase.test.json`: Emulatorã®ãƒãƒ¼ãƒˆ

### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®è¨­å®š

`tests/setup-db.ts`ã§ãƒ†ã‚¹ãƒˆç”¨ã®åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã§ãã¾ã™ã€‚

### E2Eãƒ†ã‚¹ãƒˆã®æ‹¡å¼µ

`tests/e2e/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ–°ã—ã„`.spec.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¦ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’æ‹¡å¼µã§ãã¾ã™ã€‚

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Firebase EmulatorãŒèµ·å‹•ã—ãªã„

```bash
# Firebase CLIã®æ›´æ–°
npm install -g firebase-tools@latest

# Java Runtime Environmentã®ç¢ºèª
java -version

# Dockerå†…ã§ã®Emulatorèµ·å‹•ç¢ºèª
docker-compose -f docker-compose.test.yml logs firebase-emulator-test

# Node.js Alpine ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã®æ‰‹å‹•ç¢ºèª
docker run -it node:18-alpine sh
apk add --no-cache openjdk11-jre
npm install -g firebase-tools
```

### ãƒãƒ¼ãƒˆç«¶åˆã‚¨ãƒ©ãƒ¼

```bash
# ä½¿ç”¨ä¸­ã®ãƒãƒ¼ãƒˆã‚’ç¢ºèª
lsof -ti:8080,9099,4000,3000

# ãƒ—ãƒ­ã‚»ã‚¹ã®çµ‚äº†
kill -9 <PID>
```

### Dockeré–¢é€£ã‚¨ãƒ©ãƒ¼

```bash
# Dockerã‚³ãƒ³ãƒ†ãƒŠã®å¼·åˆ¶åœæ­¢ãƒ»å‰Šé™¤
docker-compose -f docker-compose.test.yml down --volumes --remove-orphans

# Docker imageã®å†ãƒ“ãƒ«ãƒ‰
docker-compose -f docker-compose.test.yml build --no-cache

# å­¤ç«‹ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
docker-compose -f docker-compose.test.yml down --remove-orphans

# Firebase Emulatorã‚³ãƒ³ãƒ†ãƒŠã®å€‹åˆ¥ç¢ºèª
docker-compose -f docker-compose.test.yml up firebase-emulator-test
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼

```bash
# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ‰‹å‹•åˆæœŸåŒ–
npm run emulator:test &
node -r esbuild-register tests/setup-db.ts
```

## ğŸ“Š CI/CDçµ±åˆ

GitHub Actionsãªã©ã®CI/CDç’°å¢ƒã§ä½¿ç”¨ã™ã‚‹å ´åˆï¼š

```yaml
# .github/workflows/test.yml
- name: Run IT Tests (Integration Tests)
  run: |
    npm run docker:test
    npm run test:integration
    npm run docker:test:down

- name: Run E2E Tests  
  run: |
    npm run docker:test
    npm run test:e2e
    npm run docker:test:down
```

## ğŸ¯ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

1. **ãƒ†ã‚¹ãƒˆã®ç‹¬ç«‹æ€§**: å„ãƒ†ã‚¹ãƒˆã¯ä»–ã®ãƒ†ã‚¹ãƒˆã«ä¾å­˜ã—ãªã„
2. **ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: ãƒ†ã‚¹ãƒˆå¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ
3. **ä¸¦åˆ—å®Ÿè¡Œ**: ITãƒ†ã‚¹ãƒˆï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆï¼‰ã¨E2Eãƒ†ã‚¹ãƒˆã¯åˆ†é›¢ã—ã¦å®Ÿè¡Œ
4. **ç’°å¢ƒåˆ†é›¢**: é–‹ç™ºç’°å¢ƒã¨ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ãƒãƒ¼ãƒˆã‚’åˆ†ã‘ã‚‹
5. **ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿**: ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®çµ±ä¸€ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
6. **Dockeræœ€é©åŒ–**: Node.js Alpineãƒ™ãƒ¼ã‚¹ã§è»½é‡ãªEmulatorç’°å¢ƒã‚’æ§‹ç¯‰
7. **åˆå›èµ·å‹•æ™‚é–“**: Firebase Emulatorã®åˆå›èµ·å‹•ã¯æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ã‚’è€ƒæ…®
8. **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†**: `firebase.test.json`ã§ãƒ›ã‚¹ãƒˆè¨­å®šã‚’é©åˆ‡ã«ç®¡ç†

## ğŸ”„ æœ€æ–°ã®å¤‰æ›´å†…å®¹ï¼ˆ2024å¹´å®Ÿè£…ï¼‰

### å®Œå…¨ãªçµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒã®æ§‹ç¯‰
- **Dockerçµ±åˆ**: Next.js + Firebase Emulator ã®ãƒ•ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒ
- **APIçµ±åˆãƒ†ã‚¹ãƒˆ**: Todo/Lists APIã®å®Œå…¨ãªCRUDæ“ä½œãƒ†ã‚¹ãƒˆï¼ˆ5ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼‰
- **å‹å®‰å…¨æ€§ã®ç¢ºä¿**: TypeScript strict mode + ESLint `@typescript-eslint/no-explicit-any` æº–æ‹ 
- **REST APIæ¨™æº–åŒ–**: HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®é©åˆ‡ãªä½¿ã„åˆ†ã‘ï¼ˆPOST: 201 Created, PUT: 200 OKï¼‰

### ãƒ†ã‚¹ãƒˆå“è³ªã®å‘ä¸Š
- **100%ã‚«ãƒãƒ¬ãƒƒã‚¸é”æˆ**: 22ãƒ•ã‚¡ã‚¤ãƒ«ã€413ãƒ†ã‚¹ãƒˆã€å…¨æˆåŠŸ
- **çµ±ä¸€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ãƒ†ã‚¹ãƒˆã§çµ±ä¸€ä½¿ç”¨
- **è¡¨è¨˜çµ±ä¸€ãƒ«ãƒ¼ãƒ«**: ãƒ†ã‚¹ãƒˆèª¬æ˜æ–‡ã®ä¸€è²«ã—ãŸè¡¨è¨˜ï¼ˆã€Œæ­£å¸¸ã«ã€œã€ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
- **Firebase Emulatoré€£æº**: å®Ÿéš›ã®Firestore + Auth Emulatorã¨ã®å®Œå…¨çµ±åˆ

### Dockeræ§‹æˆã®æœ€é©åŒ–
- **è»½é‡åŒ–**: `node:18-alpine` ãƒ™ãƒ¼ã‚¹ã§é«˜é€Ÿèµ·å‹•ã‚’å®Ÿç¾
- **ç’°å¢ƒåˆ†é›¢**: é–‹ç™ºç”¨ï¼ˆãƒãƒ¼ãƒˆ3000/4000ï¼‰ã¨ãƒ†ã‚¹ãƒˆç”¨ï¼ˆãƒãƒ¼ãƒˆ3001/4001ï¼‰ã®å®Œå…¨åˆ†é›¢
- **Firebase CLIå®‰å®šåŒ–**: npmçµŒç”±ã§ã®ç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ä¾å­˜é–¢ä¿‚ã‚’è§£æ±º
- **è¨­å®šçµ±ä¸€**: `firebase.test.json`ã«ã‚ˆã‚‹çµ±ä¸€è¨­å®šç®¡ç†

### APIå®Ÿè£…ã®æ”¹å–„
- **withAuthenticatedUser**: èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å‹å®‰å…¨ãªå®Ÿè£…
- **Firebase Admin SDK**: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰èªè¨¼ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã®çµ±åˆ
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: é©åˆ‡ãªHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã¨è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- **Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã®å‹å®‰å…¨æ€§ç¢ºä¿

### E2Eãƒ†ã‚¹ãƒˆã®æ‹¡å……
- **èªè¨¼ãƒ•ãƒ­ãƒ¼**: NextAuth.js + Firebase Admin SDK ã®å®Œå…¨ãªãƒ†ã‚¹ãƒˆ
- **Todoå…¨æ©Ÿèƒ½**: ä½œæˆâ†’ç·¨é›†â†’å‰Šé™¤â†’ãƒ”ãƒ³ç•™ã‚ã®åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆ
- **ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—**: @dnd-kit/core ã«ã‚ˆã‚‹ä¸¦ã³æ›¿ãˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
- **ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ**: ãƒ¢ãƒã‚¤ãƒ«/ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è¡¨ç¤ºã®è‡ªå‹•ãƒ†ã‚¹ãƒˆ
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ**: Firebase Emulatorã¨ã®å®Ÿãƒ‡ãƒ¼ã‚¿é€£æºãƒ†ã‚¹ãƒˆ